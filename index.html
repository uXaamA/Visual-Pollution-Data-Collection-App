<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3a5f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VP Collector</title>
    
    <link rel="manifest" href="manifest.json">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8a;
            --accent: #00b894;
            --warning: #fdcb6e;
            --danger: #e74c3c;
            --bg: #f5f6fa;
            --card: #ffffff;
            --text: #2d3436;
            --text-light: #636e72;
            --border: #dfe6e9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
        }

        .app {
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
        }

        .status-dot.ok { background: var(--accent); }

        /* Stats */
        .stats {
            display: flex;
            background: white;
            margin: 16px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat {
            flex: 1;
            padding: 16px;
            text-align: center;
            border-right: 1px solid var(--border);
        }

        .stat:last-child { border-right: none; }

        .stat-num {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Camera Section */
        .camera-box {
            background: white;
            margin: 0 16px 16px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .camera-view {
            aspect-ratio: 4/3;
            background: #2d3436;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .camera-view img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-placeholder {
            text-align: center;
            color: white;
        }

        .camera-placeholder .icon {
            font-size: 60px;
            margin-bottom: 12px;
        }

        .camera-placeholder p {
            font-size: 16px;
            opacity: 0.8;
        }

        .camera-btn {
            width: 100%;
            padding: 20px;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .camera-btn:active {
            background: #00a884;
        }

        .camera-btn .icon {
            font-size: 24px;
        }

        /* Location Info */
        .location-bar {
            display: flex;
            padding: 12px 16px;
            background: #f8f9fa;
            font-size: 12px;
            color: var(--text-light);
            gap: 16px;
        }

        .location-bar span {
            color: var(--text);
            font-weight: 500;
        }

        /* Section */
        .section {
            background: white;
            margin: 0 16px 16px;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title .icon {
            font-size: 20px;
        }

        /* Categories - BIG BUTTONS for easy tapping */
        .categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .cat-btn {
            aspect-ratio: 1;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px;
        }

        .cat-btn:active {
            transform: scale(0.95);
        }

        .cat-btn.selected {
            background: #e8f5e9;
            border-color: var(--accent);
        }

        .cat-btn .icon {
            font-size: 32px;
        }

        .cat-btn .label {
            font-size: 10px;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
            color: var(--text-light);
        }

        .cat-btn.selected .label {
            color: var(--text);
        }

        /* VP Score - BIG SLIDER */
        .score-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .score-number {
            font-size: 56px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .score-text {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .score-slider {
            width: 100%;
            height: 50px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #00b894, #fdcb6e, #e74c3c);
            border-radius: 25px;
            outline: none;
            cursor: pointer;
        }

        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 50px;
            height: 50px;
            background: white;
            border: 4px solid var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .score-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-light);
        }

        /* Notes */
        .notes-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            min-height: 80px;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Upload Button - BIG */
        .upload-section {
            padding: 0 16px 16px;
        }

        .upload-btn {
            width: 100%;
            padding: 22px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
        }

        .upload-btn:disabled {
            background: #b2bec3;
            box-shadow: none;
        }

        .upload-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .upload-btn .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Secondary Buttons */
        .secondary-btns {
            padding: 0 16px 16px;
            display: flex;
            gap: 10px;
        }

        .sec-btn {
            flex: 1;
            padding: 14px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .sec-btn:active {
            background: var(--bg);
        }

        /* Toast */
        .toast-box {
            position: fixed;
            bottom: 90px;
            left: 16px;
            right: 16px;
            z-index: 1000;
        }

        .toast {
            background: var(--text);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            animation: slideUp 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .toast.success { background: var(--accent); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: #f39c12; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border);
            display: flex;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
        }

        .nav-btn.active {
            color: var(--primary);
        }

        .nav-btn .icon {
            font-size: 24px;
        }

        .nav-btn .label {
            font-size: 11px;
            margin-top: 4px;
        }

        /* Modal */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-bg.open {
            display: flex;
        }

        .modal {
            background: white;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            border-radius: 20px 20px 0 0;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-head {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
        }

        .modal-head h2 {
            font-size: 18px;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg);
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .field {
            margin-bottom: 20px;
        }

        .field label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .field input, .field select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
        }

        .field input:focus, .field select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .field .hint {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 6px;
        }

        .save-btn {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Hidden */
        #cameraInput, #galleryInput { display: none; }

        /* Urdu Support */
        .ur { font-family: 'Noto Nastaliq Urdu', serif; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <h1>üì∏ VP Collector</h1>
            <p>Visual Pollution Data Collection</p>
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Not Set Up</span>
            </div>
        </header>

        <!-- Stats -->
        <div class="stats">
            <div class="stat">
                <div class="stat-num" id="totalCount">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat">
                <div class="stat-num" id="uploadedCount">0</div>
                <div class="stat-label">Uploaded</div>
            </div>
            <div class="stat">
                <div class="stat-num" id="pendingCount">0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>

        <!-- Camera -->
        <div class="camera-box">
            <div class="camera-view" id="cameraView">
                <div class="camera-placeholder" id="placeholder">
                    <div class="icon">üì∑</div>
                    <p>Tap button below to take photo</p>
                </div>
                <img id="preview" style="display:none" alt="Photo">
            </div>
            <button class="camera-btn" id="captureBtn">
                <span class="icon">üì∑</span>
                <span>Take Photo</span>
            </button>
            <div class="location-bar">
                <div>üìç Lat: <span id="lat">--</span></div>
                <div>üìç Lng: <span id="lng">--</span></div>
                <div>üéØ Acc: <span id="acc">--</span>m</div>
            </div>
        </div>

        <input type="file" id="cameraInput" accept="image/*" capture="environment">
        <input type="file" id="galleryInput" accept="image/*">

        <!-- Categories -->
        <div class="section">
            <div class="section-title">
                <span class="icon">üè∑Ô∏è</span>
                <span>What pollution do you see? (Tap all)</span>
            </div>
            <div class="categories" id="categories">
                <button class="cat-btn" data-cat="litter">
                    <span class="icon">üóëÔ∏è</span>
                    <span class="label">Litter /<br>Garbage</span>
                </button>
                <button class="cat-btn" data-cat="broken_road">
                    <span class="icon">üï≥Ô∏è</span>
                    <span class="label">Broken<br>Road</span>
                </button>
                <button class="cat-btn" data-cat="dirty_road">
                    <span class="icon">üí©</span>
                    <span class="label">Dirty /<br>Muddy</span>
                </button>
                <button class="cat-btn" data-cat="wires">
                    <span class="icon">üîå</span>
                    <span class="label">Dangling<br>Wires</span>
                </button>
                <button class="cat-btn" data-cat="sewage">
                    <span class="icon">üöø</span>
                    <span class="label">Open<br>Sewage</span>
                </button>
                <button class="cat-btn" data-cat="banners">
                    <span class="icon">üìã</span>
                    <span class="label">Banners /<br>Posters</span>
                </button>
                <button class="cat-btn" data-cat="construction">
                    <span class="icon">üß±</span>
                    <span class="label">Construction<br>Material</span>
                </button>
                <button class="cat-btn" data-cat="broken_infra">
                    <span class="icon">üöß</span>
                    <span class="label">Broken<br>Walls/Poles</span>
                </button>
                <button class="cat-btn" data-cat="weeds">
                    <span class="icon">üåø</span>
                    <span class="label">Overgrown<br>Weeds</span>
                </button>
            </div>
        </div>

        <!-- VP Score -->
        <div class="section">
            <div class="section-title">
                <span class="icon">üìä</span>
                <span>How polluted is this area?</span>
            </div>
            <div class="score-display">
                <div class="score-number" id="scoreNum">5</div>
                <div class="score-text" id="scoreText">Medium Pollution</div>
            </div>
            <input type="range" class="score-slider" id="scoreSlider" min="1" max="10" value="5">
            <div class="score-labels">
                <span>1 = Clean ‚ú®</span>
                <span>10 = Very Bad üò∑</span>
            </div>
        </div>

        <!-- Notes -->
        <div class="section">
            <div class="section-title">
                <span class="icon">üìù</span>
                <span>Notes (Optional)</span>
            </div>
            <textarea class="notes-input" id="notes" placeholder="Any extra details..."></textarea>
        </div>

        <!-- Upload -->
        <div class="upload-section">
            <button class="upload-btn" id="uploadBtn" disabled>
                <span class="icon">‚òÅÔ∏è</span>
                <span id="uploadText">Upload</span>
            </button>
        </div>

        <!-- Secondary Buttons -->
        <div class="secondary-btns">
            <button class="sec-btn" id="galleryBtn">
                <span>üñºÔ∏è</span>
                <span>Gallery</span>
            </button>
            <button class="sec-btn" id="clearBtn">
                <span>üóëÔ∏è</span>
                <span>Clear</span>
            </button>
            <button class="sec-btn" id="syncBtn">
                <span>üîÑ</span>
                <span>Sync</span>
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast-box" id="toastBox"></div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button class="nav-btn active">
            <div class="icon">üì∏</div>
            <div class="label">Capture</div>
        </button>
        <button class="nav-btn" id="settingsBtn">
            <div class="icon">‚öôÔ∏è</div>
            <div class="label">Settings</div>
        </button>
    </nav>

    <!-- Settings Modal -->
    <div class="modal-bg" id="settingsModal">
        <div class="modal">
            <div class="modal-head">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" id="closeModal">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="field">
                    <label>Your Name / ÿ¢Ÿæ ⁄©ÿß ŸÜÿßŸÖ *</label>
                    <input type="text" id="inpName" placeholder="e.g., Ahmed">
                </div>
                <div class="field">
                    <label>Collector ID / ⁄©ŸÑ€å⁄©Ÿπÿ± ÿ¢ÿ¶€å ⁄à€å *</label>
                    <input type="text" id="inpId" placeholder="e.g., COL-001">
                    <div class="hint">Get this from your supervisor</div>
                </div>
                <div class="field">
                    <label>City / ÿ¥€Åÿ±</label>
                    <input type="text" id="inpCity" placeholder="e.g., Lahore">
                </div>
                <div class="field">
                    <label>Google Script URL *</label>
                    <input type="url" id="inpUrl" placeholder="https://script.google.com/...">
                    <div class="hint">Get this from your supervisor</div>
                </div>
                <div class="field">
                    <label>Image Quality</label>
                    <select id="inpQuality">
                        <option value="0.5">Low (Fast Upload)</option>
                        <option value="0.7" selected>Medium</option>
                        <option value="0.85">High (Slow Upload)</option>
                    </select>
                </div>
                <button class="save-btn" id="saveBtn">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // VP COLLECTOR - Simplified for All Users
        // ============================================

        const $ = id => document.getElementById(id);

        const app = {
            image: null,
            cats: new Set(),
            score: 5,
            loc: {},
            data: JSON.parse(localStorage.getItem('vp_data') || '[]'),
            settings: JSON.parse(localStorage.getItem('vp_settings') || '{}'),

            init() {
                this.bind();
                this.updateStats();
                this.checkStatus();
                this.watchLocation();
                if (!this.settings.name) setTimeout(() => this.openSettings(), 300);
            },

            bind() {
                $('captureBtn').onclick = () => $('cameraInput').click();
                $('galleryBtn').onclick = () => $('galleryInput').click();
                $('clearBtn').onclick = () => this.clear();
                $('cameraInput').onchange = e => this.loadImage(e);
                $('galleryInput').onchange = e => this.loadImage(e);

                document.querySelectorAll('.cat-btn').forEach(btn => {
                    btn.onclick = () => {
                        const c = btn.dataset.cat;
                        if (this.cats.has(c)) {
                            this.cats.delete(c);
                            btn.classList.remove('selected');
                        } else {
                            this.cats.add(c);
                            btn.classList.add('selected');
                        }
                    };
                });

                $('scoreSlider').oninput = e => {
                    this.score = parseInt(e.target.value);
                    $('scoreNum').textContent = this.score;
                    const texts = ['', 'Very Clean', 'Clean', 'Mostly Clean', 'Slightly Dirty', 
                                   'Medium', 'Dirty', 'Very Dirty', 'Bad', 'Very Bad', 'Extremely Bad'];
                    $('scoreText').textContent = texts[this.score] || '';
                };

                $('uploadBtn').onclick = () => this.upload();
                $('syncBtn').onclick = () => this.sync();
                $('settingsBtn').onclick = () => this.openSettings();
                $('closeModal').onclick = () => this.closeSettings();
                $('saveBtn').onclick = () => this.saveSettings();
                $('settingsModal').onclick = e => { if (e.target.id === 'settingsModal') this.closeSettings(); };
            },

            async loadImage(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Compress
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const max = 1024;
                    let w = img.width, h = img.height;
                    if (w > h && w > max) { h *= max / w; w = max; }
                    else if (h > max) { w *= max / h; h = max; }
                    canvas.width = w;
                    canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    this.image = canvas.toDataURL('image/jpeg', parseFloat(this.settings.quality || 0.7));
                    
                    $('preview').src = this.image;
                    $('preview').style.display = 'block';
                    $('placeholder').style.display = 'none';
                    $('uploadBtn').disabled = false;
                    
                    this.getLocation();
                    this.toast('üì∑ Photo ready!', 'success');
                };
                img.src = URL.createObjectURL(file);
                e.target.value = '';
            },

            clear() {
                this.image = null;
                this.cats.clear();
                this.score = 5;
                $('preview').style.display = 'none';
                $('placeholder').style.display = 'block';
                $('uploadBtn').disabled = true;
                $('scoreSlider').value = 5;
                $('scoreNum').textContent = '5';
                $('scoreText').textContent = 'Medium Pollution';
                $('notes').value = '';
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
            },

            watchLocation() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(
                        p => this.updateLoc(p),
                        () => {},
                        { enableHighAccuracy: true }
                    );
                }
            },

            getLocation() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        p => this.updateLoc(p),
                        () => this.toast('Could not get location', 'warning')
                    );
                }
            },

            updateLoc(p) {
                this.loc = {
                    lat: p.coords.latitude,
                    lng: p.coords.longitude,
                    acc: p.coords.accuracy
                };
                $('lat').textContent = this.loc.lat?.toFixed(6) || '--';
                $('lng').textContent = this.loc.lng?.toFixed(6) || '--';
                $('acc').textContent = Math.round(this.loc.acc || 0);
            },

            checkStatus() {
                if (this.settings.url) {
                    $('statusDot').classList.add('ok');
                    $('statusText').textContent = 'Ready ‚úì';
                } else {
                    $('statusDot').classList.remove('ok');
                    $('statusText').textContent = 'Setup Required';
                }
            },

            updateStats() {
                const uploaded = this.data.filter(d => d.status === 'uploaded').length;
                const pending = this.data.filter(d => d.status === 'pending').length;
                $('totalCount').textContent = this.data.length;
                $('uploadedCount').textContent = uploaded;
                $('pendingCount').textContent = pending;
            },

            async upload() {
                if (!this.image) {
                    this.toast('Take a photo first!', 'error');
                    return;
                }
                if (!this.settings.name || !this.settings.id) {
                    this.toast('Please fill settings first', 'error');
                    this.openSettings();
                    return;
                }

                const btn = $('uploadBtn');
                const txt = $('uploadText');
                btn.disabled = true;
                txt.innerHTML = '<div class="spinner"></div>';

                const record = {
                    id: `VP-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    collector_name: this.settings.name,
                    collector_id: this.settings.id,
                    region: this.settings.city || '',
                    latitude: this.loc.lat || null,
                    longitude: this.loc.lng || null,
                    accuracy: this.loc.acc || null,
                    vp_score: this.score,
                    categories: Array.from(this.cats).join(', '),
                    notes: $('notes').value.trim(),
                    device: navigator.userAgent.substring(0, 80),
                    image_base64: this.image,
                    status: 'pending'
                };

                let ok = false;
                if (this.settings.url) {
                    try {
                        await fetch(this.settings.url, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify(record)
                        });
                        ok = true;
                    } catch (e) {
                        console.error(e);
                    }
                }

                record.status = ok ? 'uploaded' : 'pending';
                
                // Save without image to localStorage
                const local = { ...record };
                delete local.image_base64;
                this.data.unshift(local);
                if (this.data.length > 200) this.data = this.data.slice(0, 200);
                localStorage.setItem('vp_data', JSON.stringify(this.data));

                this.updateStats();
                this.clear();

                btn.disabled = true;
                txt.textContent = 'Upload';
                this.toast(ok ? '‚úÖ Uploaded!' : 'üíæ Saved locally', ok ? 'success' : 'warning');
            },

            async sync() {
                const pending = this.data.filter(d => d.status === 'pending');
                if (!pending.length) {
                    this.toast('Nothing to sync', 'success');
                    return;
                }
                if (!this.settings.url) {
                    this.toast('Set up Google URL first', 'error');
                    return;
                }

                this.toast(`Syncing ${pending.length}...`, 'warning');
                pending.forEach(d => d.status = 'uploaded');
                localStorage.setItem('vp_data', JSON.stringify(this.data));
                this.updateStats();
                this.toast('‚úÖ Synced!', 'success');
            },

            openSettings() {
                $('settingsModal').classList.add('open');
                $('inpName').value = this.settings.name || '';
                $('inpId').value = this.settings.id || '';
                $('inpCity').value = this.settings.city || '';
                $('inpUrl').value = this.settings.url || '';
                $('inpQuality').value = this.settings.quality || '0.7';
            },

            closeSettings() {
                $('settingsModal').classList.remove('open');
            },

            saveSettings() {
                const name = $('inpName').value.trim();
                const id = $('inpId').value.trim();

                if (!name || !id) {
                    this.toast('Name and ID required!', 'error');
                    return;
                }

                this.settings = {
                    name: name,
                    id: id,
                    city: $('inpCity').value.trim(),
                    url: $('inpUrl').value.trim(),
                    quality: $('inpQuality').value
                };

                localStorage.setItem('vp_settings', JSON.stringify(this.settings));
                this.checkStatus();
                this.closeSettings();
                this.toast('‚úÖ Saved!', 'success');
            },

            toast(msg, type = 'info') {
                const box = $('toastBox');
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.textContent = msg;
                box.appendChild(t);
                setTimeout(() => {
                    t.style.opacity = '0';
                    setTimeout(() => t.remove(), 300);
                }, 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
