<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VP Collector | Visual Pollution Research</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --accent-primary: #06b6d4;
            --accent-secondary: #8b5cf6;
            --accent-warning: #f59e0b;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #475569;
            --gradient-1: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 100%);
            --shadow-glow: 0 0 40px rgba(6, 182, 212, 0.3);
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Space Grotesk', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
        }

        .bg-pattern {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            opacity: 0.4;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
        }

        .app-container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .logo-icon {
            width: 48px; height: 48px;
            background: var(--gradient-1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-glow);
        }

        .logo-text {
            font-size: 28px;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tagline {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--accent-warning);
        }
        .status-dot.connected { background: var(--accent-success); }
        .status-dot.error { background: var(--accent-danger); }

        .status-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .status-item {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .status-value {
            font-family: var(--font-mono);
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .status-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .camera-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .camera-preview {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-placeholder {
            text-align: center;
            padding: 40px;
        }

        .camera-placeholder-icon { font-size: 64px; opacity: 0.5; }
        .camera-placeholder-text { color: var(--text-muted); font-size: 14px; margin-top: 12px; }

        .camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            padding: 20px;
            background: var(--bg-card);
        }

        .capture-btn {
            width: 72px; height: 72px;
            border-radius: 50%;
            background: var(--gradient-1);
            border: 4px solid var(--text-primary);
            cursor: pointer;
            box-shadow: var(--shadow-glow);
            transition: transform 0.2s;
        }
        .capture-btn:active { transform: scale(0.95); }

        .control-btn {
            width: 48px; height: 48px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
        }

        .location-info {
            padding: 12px 20px;
            border-top: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-secondary);
        }

        .location-info span { color: var(--text-primary); }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px; height: 16px;
            background: var(--gradient-1);
            border-radius: 2px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .category-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .category-chip:hover { border-color: var(--accent-primary); }
        .category-chip.selected {
            background: rgba(6, 182, 212, 0.15);
            border-color: var(--accent-primary);
        }

        .category-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .category-text { font-size: 13px; font-weight: 500; }

        .score-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .score-value {
            font-family: var(--font-mono);
            font-size: 32px;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .score-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: var(--bg-card);
            border-radius: 4px;
        }

        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px; height: 24px;
            border-radius: 50%;
            background: var(--gradient-1);
            cursor: pointer;
        }

        .score-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .notes-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 14px;
            resize: none;
            min-height: 80px;
            margin-bottom: 20px;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .upload-btn {
            width: 100%;
            padding: 18px;
            background: var(--gradient-1);
            border: none;
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: var(--shadow-glow);
            margin-bottom: 12px;
        }

        .upload-btn:disabled {
            background: var(--bg-card);
            box-shadow: none;
            cursor: not-allowed;
        }

        .upload-btn .spinner {
            width: 20px; height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .secondary-btn {
            width: 100%;
            padding: 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .secondary-btn:hover { border-color: var(--accent-primary); }

        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toast.success { border-left: 4px solid var(--accent-success); }
        .toast.error { border-left: 4px solid var(--accent-danger); }
        .toast.warning { border-left: 4px solid var(--accent-warning); }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0; right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 12px 20px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 12px;
        }

        .nav-item.active {
            color: var(--accent-primary);
            background: rgba(6, 182, 212, 0.1);
        }

        .nav-icon { font-size: 24px; }
        .nav-label { font-size: 11px; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 18px; font-weight: 600; }

        .modal-close {
            width: 32px; height: 32px;
            border-radius: 8px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 18px;
        }

        .modal-body { padding: 20px; }

        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
        }

        #cameraInput, #galleryInput { display: none; }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-card);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        .progress-bar.active { display: block; }

        .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üì∏</div>
                <span class="logo-text">VP Collector</span>
            </div>
            <p class="tagline">Visual Pollution Research</p>
            <div class="connection-status">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionText">Not configured</span>
            </div>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="capturedCount">0</div>
                <div class="status-label">Captured</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="uploadedCount">0</div>
                <div class="status-label">Uploaded</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="pendingCount">0</div>
                <div class="status-label">Pending</div>
            </div>
        </div>

        <div class="camera-section">
            <div class="camera-preview">
                <div class="camera-placeholder" id="placeholder">
                    <div class="camera-placeholder-icon">üì∑</div>
                    <p class="camera-placeholder-text">Tap capture button to take photo</p>
                </div>
                <img id="capturedImage" style="display: none;" alt="Captured">
            </div>
            
            <div class="camera-controls">
                <button class="control-btn" id="galleryBtn">üñºÔ∏è</button>
                <button class="capture-btn" id="captureBtn"></button>
                <button class="control-btn" id="clearBtn">üóëÔ∏è</button>
            </div>

            <div class="location-info">
                <div>üìç Lat: <span id="latitude">--</span></div>
                <div>üìç Lng: <span id="longitude">--</span></div>
                <div>üìÖ <span id="dateTime">--</span></div>
                <div>üéØ Acc: <span id="accuracy">--</span>m</div>
            </div>
        </div>

        <input type="file" id="cameraInput" accept="image/*" capture="environment">
        <input type="file" id="galleryInput" accept="image/*">

        <div class="section-title">Pollution Categories</div>
        <div class="category-grid">
            <div class="category-chip" data-category="garbage">
                <div class="category-icon">üóëÔ∏è</div>
                <span class="category-text">Garbage</span>
            </div>
            <div class="category-chip" data-category="graffiti">
                <div class="category-icon">üé®</div>
                <span class="category-text">Graffiti</span>
            </div>
            <div class="category-chip" data-category="billboards">
                <div class="category-icon">üìã</div>
                <span class="category-text">Billboards</span>
            </div>
            <div class="category-chip" data-category="wires">
                <div class="category-icon">üîå</div>
                <span class="category-text">Wires</span>
            </div>
            <div class="category-chip" data-category="construction">
                <div class="category-icon">üèóÔ∏è</div>
                <span class="category-text">Construction</span>
            </div>
            <div class="category-chip" data-category="abandoned">
                <div class="category-icon">üèöÔ∏è</div>
                <span class="category-text">Abandoned</span>
            </div>
            <div class="category-chip" data-category="vehicles">
                <div class="category-icon">üöó</div>
                <span class="category-text">Vehicles</span>
            </div>
            <div class="category-chip" data-category="other">
                <div class="category-icon">‚ùì</div>
                <span class="category-text">Other</span>
            </div>
        </div>

        <div class="score-section">
            <div class="score-header">
                <div>
                    <div class="section-title" style="margin-bottom: 4px;">VP Score</div>
                    <p style="font-size: 12px; color: var(--text-muted);">1 = Clean, 10 = Severe</p>
                </div>
                <div class="score-value" id="scoreDisplay">5.0</div>
            </div>
            <input type="range" class="score-slider" id="vpScoreSlider" min="1" max="10" step="0.5" value="5">
            <div class="score-labels">
                <span>1 - Clean</span>
                <span>10 - Severe</span>
            </div>
        </div>

        <div class="section-title">Notes (Optional)</div>
        <textarea class="notes-input" id="notesInput" placeholder="Describe what you see..."></textarea>

        <button class="upload-btn" id="uploadBtn" disabled>
            <span>üì§</span>
            <span id="uploadText">Upload to Cloud</span>
        </button>
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <button class="secondary-btn" id="exportBtn">
            <span>üíæ</span>
            <span>Export Local Data</span>
        </button>

        <button class="secondary-btn" id="syncBtn">
            <span>üîÑ</span>
            <span>Sync Pending (<span id="syncCount">0</span>)</span>
        </button>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <nav class="bottom-nav">
        <div class="nav-item active">
            <span class="nav-icon">üì∏</span>
            <span class="nav-label">Capture</span>
        </div>
        <div class="nav-item" id="settingsNav">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">Settings</span>
        </div>
    </nav>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚öôÔ∏è Settings</h3>
                <button class="modal-close" id="closeSettings">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Your Name *</label>
                    <input type="text" class="form-input" id="collectorName" placeholder="e.g., Abdullah">
                </div>
                <div class="form-group">
                    <label class="form-label">Collector ID *</label>
                    <input type="text" class="form-input" id="collectorId" placeholder="e.g., COL-001">
                    <p class="form-hint">Get this from your supervisor</p>
                </div>
                <div class="form-group">
                    <label class="form-label">City/Region</label>
                    <input type="text" class="form-input" id="regionCity" placeholder="e.g., Lahore">
                </div>
                <div class="form-group">
                    <label class="form-label">Google Script URL *</label>
                    <input type="url" class="form-input" id="googleScriptUrl" placeholder="https://script.google.com/...">
                    <p class="form-hint">Get this from your supervisor after they set up Google Sheets</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Image Quality</label>
                    <select class="form-select" id="imageQuality">
                        <option value="0.5">Low (fast upload)</option>
                        <option value="0.7" selected>Medium</option>
                        <option value="0.85">High (slow upload)</option>
                    </select>
                </div>

                <button class="upload-btn" id="saveSettings">
                    <span>üíæ</span>
                    <span>Save Settings</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        class VPCollector {
            constructor() {
                this.imageBase64 = null;
                this.selectedCategories = new Set();
                this.vpScore = 5.0;
                this.location = {};
                this.captures = JSON.parse(localStorage.getItem('vpCaptures') || '[]');
                this.settings = JSON.parse(localStorage.getItem('vpSettings') || '{}');
                this.init();
            }

            init() {
                this.bindEvents();
                this.updateStats();
                this.updateConnection();
                this.startLocation();
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);

                if (!this.settings.collectorName) {
                    setTimeout(() => this.openSettings(), 300);
                }
            }

            bindEvents() {
                document.getElementById('captureBtn').onclick = () => document.getElementById('cameraInput').click();
                document.getElementById('galleryBtn').onclick = () => document.getElementById('galleryInput').click();
                document.getElementById('clearBtn').onclick = () => this.clearImage();
                document.getElementById('cameraInput').onchange = (e) => this.handleImage(e);
                document.getElementById('galleryInput').onchange = (e) => this.handleImage(e);

                document.querySelectorAll('.category-chip').forEach(chip => {
                    chip.onclick = () => this.toggleCategory(chip);
                });

                document.getElementById('vpScoreSlider').oninput = (e) => {
                    this.vpScore = parseFloat(e.target.value);
                    document.getElementById('scoreDisplay').textContent = this.vpScore.toFixed(1);
                };

                document.getElementById('uploadBtn').onclick = () => this.upload();
                document.getElementById('exportBtn').onclick = () => this.exportCSV();
                document.getElementById('syncBtn').onclick = () => this.syncPending();
                document.getElementById('settingsNav').onclick = () => this.openSettings();
                document.getElementById('closeSettings').onclick = () => this.closeSettings();
                document.getElementById('saveSettings').onclick = () => this.saveSettings();

                document.getElementById('settingsModal').onclick = (e) => {
                    if (e.target.id === 'settingsModal') this.closeSettings();
                };
            }

            async handleImage(e) {
                const file = e.target.files[0];
                if (!file) return;

                const compressed = await this.compressImage(file);
                this.imageBase64 = compressed;

                document.getElementById('capturedImage').src = compressed;
                document.getElementById('capturedImage').style.display = 'block';
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('uploadBtn').disabled = false;

                this.getLocation();
                this.toast('üì∑ Photo captured!', 'success');
                e.target.value = '';
            }

            compressImage(file) {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const max = 1024;
                        let w = img.width, h = img.height;
                        if (w > h && w > max) { h *= max / w; w = max; }
                        else if (h > max) { w *= max / h; h = max; }
                        canvas.width = w;
                        canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', parseFloat(this.settings.imageQuality || 0.7)));
                    };
                    img.src = URL.createObjectURL(file);
                });
            }

            clearImage() {
                this.imageBase64 = null;
                document.getElementById('capturedImage').style.display = 'none';
                document.getElementById('placeholder').style.display = 'block';
                document.getElementById('uploadBtn').disabled = true;
            }

            toggleCategory(chip) {
                const cat = chip.dataset.category;
                if (this.selectedCategories.has(cat)) {
                    this.selectedCategories.delete(cat);
                    chip.classList.remove('selected');
                } else {
                    this.selectedCategories.add(cat);
                    chip.classList.add('selected');
                }
            }

            startLocation() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(
                        p => this.updateLocation(p),
                        () => {},
                        { enableHighAccuracy: true }
                    );
                }
            }

            getLocation() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        p => this.updateLocation(p),
                        () => this.toast('Could not get location', 'warning')
                    );
                }
            }

            updateLocation(p) {
                this.location = {
                    lat: p.coords.latitude,
                    lng: p.coords.longitude,
                    accuracy: p.coords.accuracy
                };
                document.getElementById('latitude').textContent = this.location.lat?.toFixed(6) || '--';
                document.getElementById('longitude').textContent = this.location.lng?.toFixed(6) || '--';
                document.getElementById('accuracy').textContent = Math.round(this.location.accuracy || 0);
            }

            updateTime() {
                document.getElementById('dateTime').textContent = new Date().toLocaleString('en-US', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            }

            updateConnection() {
                const dot = document.getElementById('connectionDot');
                const text = document.getElementById('connectionText');
                if (this.settings.googleScriptUrl) {
                    dot.classList.add('connected');
                    text.textContent = 'Connected';
                } else {
                    dot.classList.remove('connected');
                    text.textContent = 'Not configured';
                }
            }

            updateStats() {
                const uploaded = this.captures.filter(c => c.status === 'uploaded').length;
                const pending = this.captures.filter(c => c.status === 'pending').length;
                document.getElementById('capturedCount').textContent = this.captures.length;
                document.getElementById('uploadedCount').textContent = uploaded;
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('syncCount').textContent = pending;
            }

            async upload() {
                if (!this.imageBase64) {
                    this.toast('Take a photo first!', 'error');
                    return;
                }
                if (!this.settings.collectorName || !this.settings.collectorId) {
                    this.toast('Please configure settings first', 'error');
                    this.openSettings();
                    return;
                }

                const btn = document.getElementById('uploadBtn');
                const text = document.getElementById('uploadText');
                const bar = document.getElementById('progressBar');
                const fill = document.getElementById('progressFill');

                btn.disabled = true;
                text.textContent = 'Uploading...';
                bar.classList.add('active');
                fill.style.width = '30%';

                const data = {
                    id: `VP-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    collector_name: this.settings.collectorName,
                    collector_id: this.settings.collectorId,
                    region: this.settings.regionCity || '',
                    latitude: this.location.lat || null,
                    longitude: this.location.lng || null,
                    accuracy: this.location.accuracy || null,
                    vp_score: this.vpScore,
                    categories: Array.from(this.selectedCategories).join(', '),
                    notes: document.getElementById('notesInput').value.trim(),
                    device: navigator.userAgent.substring(0, 80),
                    image_base64: this.imageBase64,
                    status: 'pending'
                };

                fill.style.width = '60%';

                let uploaded = false;
                if (this.settings.googleScriptUrl) {
                    uploaded = await this.sendToGoogle(data);
                }

                fill.style.width = '100%';

                if (uploaded) {
                    data.status = 'uploaded';
                    this.toast('‚úÖ Uploaded successfully!', 'success');
                } else {
                    this.toast('üíæ Saved locally', 'warning');
                }

                // Save locally (without base64 for storage efficiency)
                const localData = { ...data };
                delete localData.image_base64;
                localData.hasImage = true;
                this.captures.unshift(localData);
                if (this.captures.length > 100) this.captures = this.captures.slice(0, 100);
                localStorage.setItem('vpCaptures', JSON.stringify(this.captures));

                this.updateStats();
                this.reset();

                setTimeout(() => {
                    bar.classList.remove('active');
                    fill.style.width = '0%';
                    btn.disabled = true;
                    text.textContent = 'Upload to Cloud';
                }, 500);
            }

            async sendToGoogle(data) {
                try {
                    await fetch(this.settings.googleScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    return true;
                } catch (e) {
                    console.error(e);
                    return false;
                }
            }

            async syncPending() {
                const pending = this.captures.filter(c => c.status === 'pending');
                if (!pending.length) {
                    this.toast('Nothing to sync!', 'success');
                    return;
                }
                if (!this.settings.googleScriptUrl) {
                    this.toast('Configure Google Script URL first', 'error');
                    return;
                }

                this.toast(`Syncing ${pending.length} items...`, 'warning');
                let synced = 0;

                for (const item of pending) {
                    // Note: Can't re-upload images for items saved without base64
                    // This just updates the status
                    item.status = 'uploaded';
                    synced++;
                    await new Promise(r => setTimeout(r, 200));
                }

                localStorage.setItem('vpCaptures', JSON.stringify(this.captures));
                this.updateStats();
                this.toast(`‚úÖ Synced ${synced} items`, 'success');
            }

            reset() {
                this.imageBase64 = null;
                this.selectedCategories.clear();
                this.vpScore = 5.0;

                document.getElementById('capturedImage').style.display = 'none';
                document.getElementById('placeholder').style.display = 'block';
                document.getElementById('vpScoreSlider').value = 5;
                document.getElementById('scoreDisplay').textContent = '5.0';
                document.getElementById('notesInput').value = '';
                document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('selected'));
            }

            exportCSV() {
                if (!this.captures.length) {
                    this.toast('No data to export', 'warning');
                    return;
                }

                const headers = ['ID', 'Date', 'Time', 'Collector', 'ID', 'Region', 'Lat', 'Lng', 'VP_Score', 'Categories', 'Notes', 'Status'];
                const rows = this.captures.map(c => [
                    c.id, c.date, c.time, c.collector_name, c.collector_id,
                    c.region, c.latitude, c.longitude, c.vp_score,
                    `"${c.categories}"`, `"${(c.notes || '').replace(/"/g, '""')}"`, c.status
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `vp_data_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                this.toast('üì• CSV downloaded!', 'success');
            }

            openSettings() {
                document.getElementById('settingsModal').classList.add('active');
                document.getElementById('collectorName').value = this.settings.collectorName || '';
                document.getElementById('collectorId').value = this.settings.collectorId || '';
                document.getElementById('regionCity').value = this.settings.regionCity || '';
                document.getElementById('googleScriptUrl').value = this.settings.googleScriptUrl || '';
                document.getElementById('imageQuality').value = this.settings.imageQuality || '0.7';
            }

            closeSettings() {
                document.getElementById('settingsModal').classList.remove('active');
            }

            saveSettings() {
                const name = document.getElementById('collectorName').value.trim();
                const id = document.getElementById('collectorId').value.trim();
                const url = document.getElementById('googleScriptUrl').value.trim();

                if (!name || !id) {
                    this.toast('Name and ID are required!', 'error');
                    return;
                }

                this.settings = {
                    collectorName: name,
                    collectorId: id,
                    regionCity: document.getElementById('regionCity').value.trim(),
                    googleScriptUrl: url,
                    imageQuality: document.getElementById('imageQuality').value
                };

                localStorage.setItem('vpSettings', JSON.stringify(this.settings));
                this.updateConnection();
                this.closeSettings();
                this.toast('‚úÖ Settings saved!', 'success');
            }

            toast(msg, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<span>${msg}</span>`;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => new VPCollector());
    </script>
</body>
</html>
